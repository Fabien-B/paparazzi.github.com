<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Paparazzi UAS: mag_calib_ukf module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="penguin_icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Paparazzi UAS
   &#160;<span id="projectnumber">v6.2_unstable</span>
   </div>
   <div id="projectbrief">Paparazzi is a free software Unmanned Aircraft System.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('module__mag_calib_ukf.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">mag_calib_ukf module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Calibrate magnetometer using UKF</b></p>
<p>Online calibration of the magnetometer sensor using an UKF approach. It is required to redirect the magnetometer measurements to this module before using them in your estimation filters. In order to do that, define the mag id for your filter (for example AHRS_MLKF_MAG_ID for the mlkf ahrs filter) to MAG_CALIB_UKF_ID.</p>
<p>For more information see TRICAL project page (<a href="https://www.github.com/sfwa/TRICAL">https://www.github.com/sfwa/TRICAL</a>).</p>
<h1><a class="anchor" id="module_load_example__mag_calib_ukf"></a>
Example for airframe file</h1>
<p>Add to your firmware section: This example contains all possible configuration options, not all of them are mandatory! </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">module</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;mag_calib_ukf&quot;</span>&gt;</div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;[AHRS/INS]_XXX_MAG_ID&quot; value=&quot;MAG_CALIB_UKF_ID&quot; /&gt;\n    &#39;</span></div>
<div class="line">&lt;/<span class="keywordtype">module</span>&gt;</div>
</div><!-- fragment --> <h1><a class="anchor" id="configuration__mag_calib_ukf"></a>
Module configuration options</h1>
<h2><a class="anchor" id="define"></a>
Define Options</h2>
<ul>
<li><b>name:</b> <code></code>[AHRS/INS]_XXX_MAG_ID <b>value:</b> <em>MAG_CALIB_UKF_ID</em> <br  />
 Description: Select correct input mag for your estimation filter (AHRS or INS), replace XXX by your filter name as defined in sw/airborne/modules/core/abi_sender_ids.h</li>
</ul>
<h2><a class="anchor" id="af_section"></a>
Airframe file section</h2>
<ul>
<li><b>section</b> name: <code>MAG_CALIB_UKF</code> prefix: <code>MAG_CALIB_UKF_</code> <ul>
<li><b>name</b> <code>NORM</code> <b>value:</b> <em>1.0f</em> <br  />
 Description: Measurement norm of magnetometer</li>
<li><b>name</b> <code>NOISE_RMS</code> <b>value:</b> <em>2e-1f</em> <br  />
 Description: Noise RMS of magnetometer</li>
<li><b>name</b> <code>ABI_BIND_ID</code> <b>value:</b> <em>ABI_BROADCAST</em> <br  />
 Description: Bind to a specific source for input data, broadcast ID by default</li>
<li><b>name</b> <code>INITIAL_STATE</code> <b>value:</b> <em>0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0</em> <br  />
 Description: Initial state to be used by filter. There is an option to send the state from settings, after which the state will be send through the PAYLOAD_FLOAT message.</li>
<li><b>name</b> <code>HOTSTART</code> <b>value:</b> <em>TRUE</em> <br  />
 Description: Read calibration on initialization and Write calibration periodically to file (only for Linux-based boards)</li>
<li><b>name</b> <code>HOTSTART_SAVE_FILE</code> <b>value:</b> <em>/data/ftp/internal_000/mag_ukf_calib.txt</em> <br  />
 Description: Hotstart save file (only for Linux-based boards)</li>
<li><b>name</b> <code>VERBOSE</code> <b>value:</b> <em>FALSE</em> <br  />
 Description: Enable terminal verbose mode (only for Linux-based boards)</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="functions__mag_calib_ukf"></a>
Module functions</h1>
<h2><a class="anchor" id="init_functions"></a>
Init Functions</h2>
<p>These initialization functions are called once on startup.</p>
<ul>
<li><a class="el" href="mag__calib__ukf_8c.html#a0398977c266b1abac931ff429ee2ffb8">mag_calib_ukf_init()</a></li>
</ul>
<h2><a class="anchor" id="periodic_functions"></a>
Periodic Functions</h2>
<p>These functions are called periodically at the specified frequency from the module periodic loop.</p>
<ul>
<li><a class="el" href="mag__calib__ukf_8c.html#af831c65cede764ed6962979a23577585">mag_calib_hotstart_write()</a><ul>
<li>Frequency in Hz: <em>0.25</em> </li>
<li>Autorun: <em>LOCK</em> <br  />
 Periodic function automatically starts after init and can't be stopped.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="files"></a>
Files</h1>
<h2><a class="anchor" id="headers"></a>
Header Files</h2>
<p>The following headers are automatically included in modules.h</p>
<ul>
<li><a class="el" href="mag__calib__ukf_8h.html">mag_calib_ukf.h</a></li>
</ul>
<h2><a class="anchor" id="sources"></a>
Source Files</h2>
<ul>
<li><a class="el" href="mag__calib__ukf_8c.html">modules/calibration/mag_calib_ukf.c</a></li>
<li>/sw/ext/TRICAL/src/TRICAL.c</li>
<li>/sw/ext/TRICAL/src/filter.c</li>
</ul>
<h2><a class="anchor" id="module_xml__mag_calib_ukf"></a>
Raw mag_calib_ukf.xml file:</h2>
<div class="fragment"><div class="line">&lt;!<span class="keyword">DOCTYPE</span> <span class="keyword">module</span> <span class="keyword">SYSTEM</span> <span class="stringliteral">&quot;module.dtd&quot;</span>&gt;</div>
<div class="line"> </div>
<div class="line">&lt;<span class="keywordtype">module</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;mag_calib_ukf&quot;</span> <span class="keyword">dir</span>=<span class="stringliteral">&quot;calibration&quot;</span> <span class="keyword">task</span>=<span class="stringliteral">&quot;sensors&quot;</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">doc</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">description</span>&gt;</div>
<div class="line">      <span class="keyword">Calibrate</span> <span class="keyword">magnetometer</span> <span class="keyword">using</span> <span class="keyword">UKF</span></div>
<div class="line">      <span class="keyword">Online</span> <span class="keyword">calibration</span> <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">magnetometer</span> <span class="keyword">sensor</span> <span class="keyword">using</span> <span class="keyword">an</span> <span class="keyword">UKF</span> <span class="keyword">approach.</span></div>
<div class="line">      <span class="keyword">It</span> <span class="keyword">is</span> <span class="keyword">required</span> <span class="keyword">to</span> <span class="keyword">redirect</span> <span class="keyword">the</span> <span class="keyword">magnetometer</span> <span class="keyword">measurements</span> <span class="keyword">to</span> <span class="keyword">this</span> <span class="keyword">module</span> <span class="keyword">before</span> <span class="keyword">using</span> <span class="keyword">them</span> <span class="keyword">in</span> <span class="keyword">your</span> <span class="keyword">estimation</span> <span class="keyword">filters.</span> <span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="keyword">do</span> <span class="keyword">that</span>, <span class="keyword">define</span> <span class="keyword">the</span> <span class="keyword">mag</span> <span class="keyword">id</span> <span class="keyword">for</span> <span class="keyword">your</span> <span class="keyword">filter</span> (<span class="keyword">for</span> <span class="keyword">example</span> <span class="keyword">AHRS_MLKF_MAG_ID</span> <span class="keyword">for</span> <span class="keyword">the</span> <span class="keyword">mlkf</span> <span class="keyword">ahrs</span> <span class="keyword">filter</span>) <span class="keyword">to</span> <span class="keyword">MAG_CALIB_UKF_ID.</span></div>
<div class="line">      </div>
<div class="line">      <span class="keyword">For</span> <span class="keyword">more</span> <span class="keyword">information</span> <span class="keyword">see</span> <span class="keyword">TRICAL</span> <span class="keyword">project</span> <span class="keyword">page</span> (<span class="keyword">https:</span>//<span class="keyword">www.github.com</span>/<span class="keyword">sfwa</span>/<span class="keyword">TRICAL</span>).</div>
<div class="line">    &lt;/<span class="keywordtype">description</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;[AHRS/INS]_XXX_MAG_ID&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;MAG_CALIB_UKF_ID&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Select correct input mag for your estimation filter (AHRS or INS), replace XXX by your filter name as defined in sw/airborne/modules/core/abi_sender_ids.h&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">section</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;MAG_CALIB_UKF&quot;</span> <span class="keyword">prefix</span>=<span class="stringliteral">&quot;MAG_CALIB_UKF_&quot;</span>&gt;</div>
<div class="line">      &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;NORM&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;1.0f&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Measurement norm of magnetometer&quot;</span>/&gt;</div>
<div class="line">      &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;NOISE_RMS&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;2e-1f&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Noise RMS of magnetometer&quot;</span>/&gt;</div>
<div class="line">      &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;ABI_BIND_ID&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;ABI_BROADCAST&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Bind to a specific source for input data, broadcast ID by default&quot;</span>/&gt;</div>
<div class="line">      &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;INITIAL_STATE&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0&quot;</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;float[]&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Initial state to be used by filter. There is an option to send the state from settings, after which the state will be send through the PAYLOAD_FLOAT message.&quot;</span>/&gt;</div>
<div class="line">      &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;HOTSTART&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;TRUE&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Read calibration on initialization and Write calibration periodically to file (only for Linux-based boards)&quot;</span>/&gt;</div>
<div class="line">      &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;HOTSTART_SAVE_FILE&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;/data/ftp/internal_000/mag_ukf_calib.txt&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Hotstart save file (only for Linux-based boards)&quot;</span>/&gt;</div>
<div class="line">      &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;VERBOSE&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;FALSE&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Enable terminal verbose mode (only for Linux-based boards)&quot;</span>/&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">section</span>&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">doc</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">settings</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">dl_settings</span>&gt;</div>
<div class="line">      &lt;<span class="keywordtype">dl_settings</span> <span class="keyword">NAME</span>=<span class="stringliteral">&quot;mag calib&quot;</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;mag_calib_ukf_send_state&quot;</span> <span class="keyword">min</span>=<span class="stringliteral">&quot;0&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;1&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;1&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;Send UKF state&quot;</span> <span class="keyword">values</span>=<span class="stringliteral">&quot;FALSE|TRUE&quot;</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;bool&quot;</span> /&gt;</div>
<div class="line">        &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;mag_calib_ukf_reset_state&quot;</span> <span class="keyword">min</span>=<span class="stringliteral">&quot;0&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;1&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;1&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;Reset UKF state&quot;</span> <span class="keyword">values</span>=<span class="stringliteral">&quot;FALSE|TRUE&quot;</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;bool&quot;</span> /&gt;</div>
<div class="line">      &lt;/<span class="keywordtype">dl_settings</span>&gt;</div>
<div class="line">    &lt;/<span class="keywordtype">dl_settings</span>&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">settings</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">header</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;mag_calib_ukf.h&quot;</span>/&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">header</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">init</span> <span class="keyword">fun</span>=<span class="stringliteral">&quot;mag_calib_ukf_init()&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">periodic</span> <span class="keyword">fun</span>=<span class="stringliteral">&quot;mag_calib_hotstart_write()&quot;</span> <span class="keyword">freq</span>=<span class="stringliteral">&quot;0.25&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">makefile</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;mag_calib_ukf.c&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">include</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;$(PAPARAZZI_SRC)/sw/ext/TRICAL/include&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">include</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;$(PAPARAZZI_SRC)/sw/ext/TRICAL/src&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;TRICAL.c&quot;</span> <span class="keyword">dir</span>=<span class="stringliteral">&quot;$(PAPARAZZI_SRC)/sw/ext/TRICAL/src&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;filter.c&quot;</span> <span class="keyword">dir</span>=<span class="stringliteral">&quot;$(PAPARAZZI_SRC)/sw/ext/TRICAL/src&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;NDEBUG&quot;</span>/&gt; <span class="comment">&lt;!-- disable assert --&gt;</span></div>
<div class="line">    &lt;<span class="keywordtype">flag</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;CFLAGS&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;Wno-unknown-pragmas -Wno-shadow&quot;</span>/&gt; <span class="comment">&lt;!-- silence warnings due to TRICAL pragmas --&gt;</span></div>
<div class="line">  &lt;/<span class="keywordtype">makefile</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">module</span>&gt;</div>
<div class="line"> </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="onboard_modules.html">Onboard Modules</a></li>
    <li class="footer">Generated on Mon Jan 31 2022 16:25:10 for Paparazzi UAS by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
