<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Paparazzi UAS: cv_undistort_image module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="penguin_icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Paparazzi UAS
   &#160;<span id="projectnumber">v6.2_unstable</span>
   </div>
   <div id="projectbrief">Paparazzi is a free software Unmanned Aircraft System.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('module__cv_undistort_image.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">cv_undistort_image module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Undistortion a fisheyelens distortion of a whole image</b></p>
<p>Note that this is quite a slow process, so it is not really advisable to use this in a vision pipeline leading to control. However, it can be used to find the right undistortion parameter k, and shows that the undistortion functions work.</p>
<p>The code also can be used to convert image coordinates from distorted fisheye lenses to undistorted coordinates and back. It takes into account the camera calibration matrix and the distortion of the specific lens.</p>
<h1><a class="anchor" id="module_load_example__cv_undistort_image"></a>
Example for airframe file</h1>
<p>Add to your firmware section: This example contains all possible configuration options, not all of them are mandatory! </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">module</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;cv_undistort_image&quot;</span>&gt;</div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;UNDISTORT_MIN_X_NORMALIZED&quot; value=&quot;-2.0&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;UNDISTORT_MAX_X_NORMALIZED&quot; value=&quot;2.0&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;UNDISTORT_FPS&quot; value=&quot;0&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;UNDISTORT_CAMERA&quot; value=&quot;bottom_camera|front_camera&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;UNDISTORT_CENTER_RATIO&quot; value=&quot;1.0&quot; /&gt;\n  &#39;</span></div>
<div class="line">&lt;/<span class="keywordtype">module</span>&gt;</div>
</div><!-- fragment --> <h1><a class="anchor" id="configuration__cv_undistort_image"></a>
Module configuration options</h1>
<h2><a class="anchor" id="define"></a>
Define Options</h2>
<ul>
<li><b>name:</b> <code>UNDISTORT_MIN_X_NORMALIZED</code> <b>value:</b> <em>-2.0</em> <br  />
 Description: Minimal normalized x-coordinate to be used for the undistortion</li>
<li><b>name:</b> <code>UNDISTORT_MAX_X_NORMALIZED</code> <b>value:</b> <em>2.0</em> <br  />
 Description: Maximal normalized x-coordinate to be used for the undistortion</li>
<li><b>name:</b> <code>UNDISTORT_FPS</code> <b>value:</b> <em>0</em> <br  />
 Description: The (maximum) frequency to run the calculations at. If zero, it will max out at the camera frame rate</li>
<li><b>name:</b> <code>UNDISTORT_CAMERA</code> <b>value:</b> <em>bottom_camera|front_camera</em> <br  />
 Description: The V4L2 camera device that is used for the calculations</li>
<li><b>name:</b> <code>UNDISTORT_CENTER_RATIO</code> <b>value:</b> <em>1.0</em> <br  />
 Description: If smaller than 1 only generate pixels for the center_ratio times the min_x to max_x interval. This makes undistortion quicker, but for a smaller FOV.</li>
</ul>
<h1><a class="anchor" id="functions__cv_undistort_image"></a>
Module functions</h1>
<h2><a class="anchor" id="init_functions"></a>
Init Functions</h2>
<p>These initialization functions are called once on startup.</p>
<ul>
<li><a class="el" href="undistort__image_8c.html#a2fe19ff135bf0c4edca40d4f630b973f">undistort_image_init()</a></li>
</ul>
<h1><a class="anchor" id="files"></a>
Files</h1>
<h2><a class="anchor" id="headers"></a>
Header Files</h2>
<p>The following headers are automatically included in modules.h</p>
<ul>
<li><a class="el" href="undistort__image_8h.html">undistort_image.h</a></li>
</ul>
<h2><a class="anchor" id="sources"></a>
Source Files</h2>
<ul>
<li><a class="el" href="undistort__image_8c.html">modules/computer_vision/undistort_image.c</a></li>
<li><a class="el" href="image_8c.html">modules/computer_vision/lib/vision/image.c</a></li>
<li><a class="el" href="undistortion_8c.html">modules/computer_vision/lib/vision/undistortion.c</a></li>
</ul>
<h2><a class="anchor" id="module_xml__cv_undistort_image"></a>
Raw cv_undistort_image.xml file:</h2>
<div class="fragment"><div class="line">&lt;!<span class="keyword">DOCTYPE</span> <span class="keyword">module</span> <span class="keyword">SYSTEM</span> <span class="stringliteral">&quot;module.dtd&quot;</span>&gt;</div>
<div class="line"> </div>
<div class="line">&lt;<span class="keywordtype">module</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;cv_undistort_image&quot;</span> <span class="keyword">dir</span>=<span class="stringliteral">&quot;computer_vision&quot;</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">doc</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">description</span>&gt;</div>
<div class="line">      <span class="keyword">Undistortion</span> <span class="keyword">a</span> <span class="keyword">fisheyelens</span> <span class="keyword">distortion</span> <span class="keyword">of</span> <span class="keyword">a</span> <span class="keyword">whole</span> <span class="keyword">image.</span> </div>
<div class="line">      <span class="keyword">Note</span> <span class="keyword">that</span> <span class="keyword">this</span> <span class="keyword">is</span> <span class="keyword">quite</span> <span class="keyword">a</span> <span class="keyword">slow</span> <span class="keyword">process</span>, <span class="keyword">so</span> <span class="keyword">it</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">really</span> <span class="keyword">advisable</span> <span class="keyword">to</span> <span class="keyword">use</span> <span class="keyword">this</span> <span class="keyword">in</span> <span class="keyword">a</span> <span class="keyword">vision</span> <span class="keyword">pipeline</span> <span class="keyword">leading</span> <span class="keyword">to</span> <span class="keyword">control.</span> </div>
<div class="line">      <span class="keyword">However</span>, <span class="keyword">it</span> <span class="keyword">can</span> <span class="keyword">be</span> <span class="keyword">used</span> <span class="keyword">to</span> <span class="keyword">find</span> <span class="keyword">the</span> <span class="keyword">right</span> <span class="keyword">undistortion</span> <span class="keyword">parameter</span> <span class="keyword">k</span>, <span class="keyword">and</span> <span class="keyword">shows</span> <span class="keyword">that</span> <span class="keyword">the</span> <span class="keyword">undistortion</span> <span class="keyword">functions</span> <span class="keyword">work.</span></div>
<div class="line"> </div>
<div class="line">      <span class="keyword">The</span> <span class="keyword">code</span> <span class="keyword">also</span> <span class="keyword">can</span> <span class="keyword">be</span> <span class="keyword">used</span> <span class="keyword">to</span> <span class="keyword">convert</span> <span class="keyword">image</span> <span class="keyword">coordinates</span> <span class="keyword">from</span> <span class="keyword">distorted</span> <span class="keyword">fisheye</span> <span class="keyword">lenses</span> <span class="keyword">to</span> <span class="keyword">undistorted</span> <span class="keyword">coordinates</span> <span class="keyword">and</span> <span class="keyword">back.</span></div>
<div class="line">      <span class="keyword">It</span> <span class="keyword">takes</span> <span class="keyword">into</span> <span class="keyword">account</span> <span class="keyword">the</span> <span class="keyword">camera</span> <span class="keyword">calibration</span> <span class="keyword">matrix</span> <span class="keyword">and</span> <span class="keyword">the</span> <span class="keyword">distortion</span> <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">specific</span> <span class="keyword">lens.</span></div>
<div class="line">    &lt;/<span class="keywordtype">description</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;UNDISTORT_MIN_X_NORMALIZED&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;-2.0&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Minimal normalized x-coordinate to be used for the undistortion&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;UNDISTORT_MAX_X_NORMALIZED&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;2.0&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Maximal normalized x-coordinate to be used for the undistortion&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;UNDISTORT_FPS&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;0&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;The (maximum) frequency to run the calculations at. If zero, it will max out at the camera frame rate&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;UNDISTORT_CAMERA&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;bottom_camera|front_camera&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;The V4L2 camera device that is used for the calculations&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;UNDISTORT_CENTER_RATIO&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;1.0&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;If smaller than 1 only generate pixels for the center_ratio times the min_x to max_x interval. This makes undistortion quicker, but for a smaller FOV.&quot;</span>/&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">doc</span>&gt;</div>
<div class="line"> </div>
<div class="line">  &lt;<span class="keywordtype">settings</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">dl_settings</span>&gt;</div>
<div class="line">      &lt;<span class="keywordtype">dl_settings</span> <span class="keyword">NAME</span>=<span class="stringliteral">&quot;Undistort&quot;</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;min_x_normalized&quot;</span>  <span class="keyword">min</span>=<span class="stringliteral">&quot;-4.0&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;0.1&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;0.0&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;min_x_n&quot;</span> <span class="keyword">param</span>=<span class="stringliteral">&quot;UNDISTORT_MIN_X_NORMALIZED&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;max_x_normalized&quot;</span>  <span class="keyword">min</span>=<span class="stringliteral">&quot;0.1&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;0.1&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;4.0&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;max_x_n&quot;</span> <span class="keyword">param</span>=<span class="stringliteral">&quot;UNDISTORT_MAX_X_NORMALIZED&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;camera_intrinsics.Dhane_k&quot;</span>  <span class="keyword">min</span>=<span class="stringliteral">&quot;1.0&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;0.01&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;2.5&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;dhane_k&quot;</span> <span class="keyword">param</span>=<span class="stringliteral">&quot;UNDISTORT_DHANE_K&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;center_ratio&quot;</span>  <span class="keyword">min</span>=<span class="stringliteral">&quot;0.05&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;0.01&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;1.0&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;center_ratio&quot;</span> <span class="keyword">param</span>=<span class="stringliteral">&quot;UNDISTORT_CENTER_RATIO&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;camera_intrinsics.focal_x&quot;</span>  <span class="keyword">min</span>=<span class="stringliteral">&quot;0.0&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;0.05&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;1024.0&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;focal_x&quot;</span> <span class="keyword">param</span>=<span class="stringliteral">&quot;UNDISTORT_FOCAL_X&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;camera_intrinsics.center_x&quot;</span>  <span class="keyword">min</span>=<span class="stringliteral">&quot;0.0&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;0.05&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;1024.0&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;center_x&quot;</span> <span class="keyword">param</span>=<span class="stringliteral">&quot;UNDISTORT_CENTER_X&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;camera_intrinsics.focal_y&quot;</span>  <span class="keyword">min</span>=<span class="stringliteral">&quot;0.0&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;0.05&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;1024.0&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;focal_y&quot;</span> <span class="keyword">param</span>=<span class="stringliteral">&quot;UNDISTORT_FOCAL_Y&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">var</span>=<span class="stringliteral">&quot;camera_intrinsics.center_y&quot;</span>  <span class="keyword">min</span>=<span class="stringliteral">&quot;0.0&quot;</span> <span class="keyword">step</span>=<span class="stringliteral">&quot;0.05&quot;</span> <span class="keyword">max</span>=<span class="stringliteral">&quot;1024.0&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;center_y&quot;</span> <span class="keyword">param</span>=<span class="stringliteral">&quot;UNDISTORT_CENTER_Y&quot;</span>/&gt;</div>
<div class="line">      &lt;/<span class="keywordtype">dl_settings</span>&gt;</div>
<div class="line">    &lt;/<span class="keywordtype">dl_settings</span>&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">settings</span>&gt;</div>
<div class="line"> </div>
<div class="line">  &lt;<span class="keywordtype">dep</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">depends</span>&gt;<span class="keyword">video_thread</span>&lt;/<span class="keywordtype">depends</span>&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">dep</span>&gt;</div>
<div class="line"> </div>
<div class="line">  &lt;<span class="keywordtype">header</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;undistort_image.h&quot;</span>/&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">header</span>&gt;</div>
<div class="line"> </div>
<div class="line">  &lt;<span class="keywordtype">init</span> <span class="keyword">fun</span>=<span class="stringliteral">&quot;undistort_image_init()&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">makefile</span> <span class="keyword">target</span>=<span class="stringliteral">&quot;ap|nps&quot;</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;undistort_image.c&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;image.c&quot;</span> <span class="keyword">dir</span>=<span class="stringliteral">&quot;modules/computer_vision/lib/vision&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;undistortion.c&quot;</span> <span class="keyword">dir</span>=<span class="stringliteral">&quot;modules/computer_vision/lib/vision&quot;</span>/&gt;    </div>
<div class="line">  &lt;/<span class="keywordtype">makefile</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">module</span>&gt;</div>
<div class="line"> </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="onboard_modules.html">Onboard Modules</a></li>
    <li class="footer">Generated on Mon Jan 31 2022 16:25:10 for Paparazzi UAS by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
